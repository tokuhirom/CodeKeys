# HACKING NOTES

開発時の思い出です。

- このアプリケーションの肝は、ショートカットキーを入力されると、その直前に入力されていたキー入力のうち繰り返されていたものを繰り返すというところにある。
  - キーロガー的な挙動と、キーの送出ができれば良い。
- rdev を利用して実装を開始した。
  - rdev を見なければ、開発を開始していなかっただろう。感謝。
- しかし、rdev の挙動では、いくつか、このアプリケーションを実現するにあたって実現不可能な挙動があった
  - OSごとの差異を隠蔽するようにしている結果、本来はOSXのAPIで実現可能な動作ができなくなっていた
  - 具体的には例えばキーショートカットが Ctrl-T となっている場合、その状態でキーを送出すると、Ctrlが押下された状態でキー入力したことになってしまうのだ。
    - これを治すためには、Control キーの keyrelease イベントを送出すれば良さそうに思うが、そうやってもコントロールキーが離れた状態にはならなかった
    - OSX では Modifier キーの押下状態は FlagChanged イベントで送出され、Control/Shift/Alt などの Modifier キーは keydown/keyup みたいな扱いになっていないっぽい気がする
  - つまりこのへんの挙動を完璧に管理するためには、OS 非依存の状態で実装をかけるのは無理だ。
  - よって、この段階で rdev をそのまま扱うのは諦める必要がある
    - coregraphics crate を直接使って、生っぽいAPIを叩く方が結局良いなという結論に至る。
  - FlagsChanged イベントを送出することで、Modifierキーの入力をクリアできた。
  - 次に、逆にモディファイヤーキーを入力しながら入力しているケースの再現だが、その際には CGEvent にモディファイヤを付属させられる。
    - 入力時点での Flags を保存しておいて、 `CGEventSetFlags` でFlags付与すれば良い。
- このアプリ自体が送出したキーイベントと、自動で入力されるキーイベントを見分けることも重要だ
  - マクロ機能で送出されたキーイベントが記録されるとわけわからんことになるので。。
  - `CGEventSetIntegerValueField` を使って、`CGEvent` にフラグを付与すればよろしい。
